<% content_for :title, "TaskMaster-Reports" %>

<div class="container py-5">
<%= link_to "‚Üê Back to Dashboard", dashboard_index_path, class: "btn btn-outline-secondary" %>
  <h2 class="mb-4 fw-bold text-dark"> Task Reports & Analytics</h2>

  <div class="row mb-4">
    <% @task_stats.each do |label, value| %>
      <% card_color = case label
        when :completed then "success"
        when :in_progress then "warning"
        when :in_review then "info"
        else "secondary"
      end %>

      <div class="col-md-3">
        <div class="card text-white bg-<%= card_color %> shadow-sm mb-3 rounded-4 border-0">
          <div class="card-body text-center">
            <h6 class="text-uppercase fw-bold mb-2"><%= label.to_s.humanize %></h6>
            <p class="display-6 fw-bold m-0"><%= value %></p>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="card mb-4 border-0 shadow-sm rounded-4">
    <div class="card-header bg-white border-bottom fw-semibold fs-5">
      ‚è±Ô∏è Time Spent per Project (in minutes)
    </div>
    <div class="card-body">
      <canvas id="timeChart" height="150"></canvas>
    </div>
  </div>

  <div class="card mb-4 border-0 shadow-sm rounded-4">
    <div class="card-header bg-white border-bottom fw-semibold fs-5">
       Task Completion Ratio
    </div>
    <div class="card-body d-flex justify-content-center">
      <div style="max-width: 300px; width: 100%;">
        <canvas id="completionChart"></canvas>
      </div>
    </div>
  </div>

  <div class="text-center mt-4">
    <button onclick="location.reload()" class="btn btn-outline-secondary">
      üîÑ Refresh Report
    </button>
  </div>
</div>

<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/chart.js" %>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const timeCtx = document.getElementById('timeChart').getContext('2d');
    const completionCtx = document.getElementById('completionChart').getContext('2d');

    // Time per project bar chart
    new Chart(timeCtx, {
      type: 'bar',
      data: {
        labels: <%= raw @time_spent_by_project.map { |p| p[:name] }.to_json %>,
        datasets: [{
          label: 'Minutes Spent',
          data: <%= raw @time_spent_by_project.map { |p| p[:time_spent] }.to_json %>,
          backgroundColor: ['#74b9ff', '#81ecec', '#ffeaa7', '#fab1a0', '#a29bfe'],
          borderRadius: 8,
          barThickness: 28
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 10 }
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });

    new Chart(completionCtx, {
      type: 'doughnut',
      data: {
        labels: <%= raw @task_stats.keys.map(&:to_s).map(&:humanize).to_json %>,
        datasets: [{
          data: <%= raw @task_stats.values.to_json %>,
          backgroundColor: ['#55efc4', '#ffeaa7', '#a29bfe', '#dfe6e9'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        cutout: '70%',
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  });
</script>

<style>
.card {
  font-family: 'Inter', sans-serif;
  transition: all 0.2s ease-in-out;
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 20px rgba(0, 0, 0, 0.08);
}
</style>
