<% content_for :title, "TaskMaster - Reports" %>

<div class="container py-5 px-3 px-md-5">
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <%= link_to dashboard_index_path, class: "btn btn-outline-secondary d-flex align-items-center gap-2" do %>
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    <% end %>
    <h2 class="fw-bold text-dark mb-0 text-center text-md-start"> Task Reports & Analytics</h2>
  </div>

  <div class="row g-3 mb-4">
    <% @task_stats.each do |label, value| %>
      <% card_color = case label
        when :completed then "success"
        when :in_progress then "warning"
        when :not_started then "info"
        else "secondary"
      end %>

      <div class="col-6 col-md-3">
        <div class="card text-white bg-<%= card_color %> shadow-sm rounded-4 border-0 h-100">
          <div class="card-body text-center py-4">
            <h6 class="text-uppercase fw-semibold small mb-1"><%= label.to_s.humanize %></h6>
            <p class="h2 fw-bold m-0"><%= value %></p>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="card mb-4 border-0 shadow-sm rounded-4">
    <div class="card-header bg-white border-bottom fw-semibold fs-5 d-flex align-items-center">
      <i class="bi bi-clock-history me-2 text-primary"></i> Time Spent per Project (minutes)
    </div>
    <div class="card-body">
      <div class="chart-container" style="position: relative; height:300px; width:100%;">
        <canvas id="timeChart"></canvas>
      </div>
    </div>
  </div>

  <div class="card mb-4 border-0 shadow-sm rounded-4">
    <div class="card-header bg-white border-bottom fw-semibold fs-5 d-flex align-items-center">
      <i class="bi bi-pie-chart me-2 text-success"></i> Task Completion Ratio
    </div>
    <div class="card-body d-flex justify-content-center">
      <div style="width: 100%; max-width: 300px;">
        <canvas id="completionChart"></canvas>
      </div>
    </div>
  </div>

  <div class="text-center mt-4">
    <button onclick="location.reload()" class="btn btn-outline-dark d-flex align-items-center gap-2">
      <i class="bi bi-arrow-repeat"></i> Refresh Report
    </button>
  </div>
</div>

<%= javascript_include_tag "https://cdn.jsdelivr.net/npm/chart.js" %>
<%= stylesheet_link_tag "https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" %>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const timeCtx = document.getElementById('timeChart').getContext('2d');
    const completionCtx = document.getElementById('completionChart').getContext('2d');

    // Bar Chart: Time per project
    new Chart(timeCtx, {
      type: 'bar',
      data: {
        labels: <%= raw @time_spent_by_project.map { |p| p[:name] }.to_json %>,
        datasets: [{
          label: 'Minutes Spent',
          data: <%= raw @time_spent_by_project.map { |p| p[:time_spent] }.to_json %>,
          backgroundColor: ['#74b9ff', '#81ecec', '#ffeaa7', '#fab1a0', '#a29bfe'],
          borderRadius: 10,
          barThickness: 28
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 10 }
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });

    // Doughnut Chart: Completion Ratio
    new Chart(completionCtx, {
      type: 'doughnut',
      data: {
        labels: <%= raw @task_stats.keys.map(&:to_s).map(&:humanize).to_json %>,
        datasets: [{
          data: <%= raw @task_stats.values.to_json %>,
          backgroundColor: ['#55efc4', '#ffeaa7', '#a29bfe', '#dfe6e9'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        cutout: '70%',
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  });
</script>

<style>
.card {
  font-family: 'Inter', sans-serif;
  transition: all 0.25s ease;
}

.card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 22px rgba(0, 0, 0, 0.08);
}

@media (max-width: 768px) {
  h2 {
    font-size: 1.4rem;
  }

  .card .h2 {
    font-size: 1.5rem;
  }

  .card-header {
    font-size: 1rem;
  }
}
</style>
